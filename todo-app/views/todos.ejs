<%
  const now = new Date();
  const today = new Date().toISOString().slice(0, 10);
  const overdue = [], dueToday = [], dueLater = [], completed = [];

  allTodos.forEach(todo => {
    const due = new Date(todo.dueDate).toISOString().slice(0, 10);
    if (todo.completed) {
      completed.push(todo);
    } else if (due < today) {
      overdue.push(todo);
    } else if (due === today) {
      dueToday.push(todo);
    } else {
      dueLater.push(todo);
    }
  });
%>

<div class="todo-sections">
  <!-- Overdue Section -->
  <div class="section">
    <h2>Overdue <span id="count-overdue"><%= overdue.length %></span></h2>
    <table class="todo-table">
      <thead>
        <tr>
          <th>Status</th>
          <th>Title</th>
          <th>Due Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% overdue.forEach(todo => { %>
          <tr class="Todo-Item">
            <td>
              <label for="todo-<%= todo.id %>">
                <input
                  type="checkbox"
                  id="todo-<%= todo.id %>"
                  onchange="toggleTodo(<%= todo.id %>, this.checked)"
                >
              </label>
            </td>
            <td><%= todo.title %></td>
            <td><%= new Date(todo.dueDate).toISOString().slice(0, 10) %></td>
            <td>
              <button onclick="deleteTodo(<%= todo.id %>)" class="delete-btn">Delete</button>
            </td>
          </tr>
        <% }); %>
      </tbody>
    </table>
  </div>

  <!-- Due Today Section -->
  <div class="section">
    <h2>Due Today <span id="count-due-today"><%= dueToday.length %></span></h2>
    <table class="todo-table">
      <thead>
        <tr>
          <th>Status</th>
          <th>Title</th>
          <th>Due Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% dueToday.forEach(todo => { %>
          <tr class="Todo-Item">
            <td>
              <label for="todo-<%= todo.id %>">
                <input
                  type="checkbox"
                  id="todo-<%= todo.id %>"
                  onchange="toggleTodo(<%= todo.id %>, this.checked)"
                >
              </label>
            </td>
            <td><%= todo.title %></td>
            <td><%= new Date(todo.dueDate).toISOString().slice(0, 10) %></td>
            <td>
              <button onclick="deleteTodo(<%= todo.id %>)" class="delete-btn">Delete</button>
            </td>
          </tr>
        <% }); %>
      </tbody>
    </table>
  </div>

  <!-- Due Later Section -->
  <div class="section">
    <h2>Due Later <span id="count-due-later"><%= dueLater.length %></span></h2>
    <table class="todo-table">
      <thead>
        <tr>
          <th>Status</th>
          <th>Title</th>
          <th>Due Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% dueLater.forEach(todo => { %>
          <tr class="Todo-Item">
            <td>
              <label for="todo-<%= todo.id %>">
                <input
                  type="checkbox"
                  id="todo-<%= todo.id %>"
                  onchange="toggleTodo(<%= todo.id %>, this.checked)"
                >
              </label>
            </td>
            <td><%= todo.title %></td>
            <td><%= new Date(todo.dueDate).toISOString().slice(0, 10) %></td>
            <td>
              <button onclick="deleteTodo(<%= todo.id %>)" class="delete-btn">Delete</button>
            </td>
          </tr>
        <% }); %>
      </tbody>
    </table>
  </div>

  <!-- Completed Section -->
  <div class="section">
    <h2>Completed <span id="count-completed"><%= completed.length %></span></h2>
    <table class="todo-table">
      <thead>
        <tr>
          <th>Status</th>
          <th>Title</th>
          <th>Due Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% completed.forEach(todo => { %>
          <tr class="Todo-Item completed">
            <td>
              <label for="todo-<%= todo.id %>">
                <input
                  type="checkbox"
                  id="todo-<%= todo.id %>"
                  checked
                  onchange="toggleTodo(<%= todo.id %>, this.checked)"
                >
              </label>
            </td>
            <td class="completed-text"><%= todo.title %></td>
            <td class="completed-text"><%= new Date(todo.dueDate).toISOString().slice(0, 10) %></td>
            <td>
              <button onclick="deleteTodo(<%= todo.id %>)" class="delete-btn">Delete</button>
            </td>
          </tr>
        <% }); %>
      </tbody>
    </table>
  </div>
</div>

<script>
  async function toggleTodo(id, completed) {
    try {
      const response = await fetch(`/todos/${id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': '<%= csrfToken %>'
        },
        body: JSON.stringify({ completed })
      });
      if (!response.ok) throw new Error('Failed to update');
      window.location.reload();
    } catch (error) {
      console.error('Error:', error);
      alert('Failed to update todo');
    }
  }

  async function deleteTodo(id) {
    if (!confirm('Are you sure you want to delete this todo?')) return;
    
    try {
      const response = await fetch(`/todos/${id}`, {
        method: 'DELETE',
        headers: {
          'X-CSRF-Token': '<%= csrfToken %>'
        }
      });
      if (!response.ok) throw new Error('Failed to delete');
      window.location.reload();
    } catch (error) {
      console.error('Error:', error);
      alert('Failed to delete todo');
    }
  }
</script>
